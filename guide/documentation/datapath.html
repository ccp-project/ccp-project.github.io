<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Datapath Program Syntax - CCP Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "../";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="../intro.html">Introduction</a></li><li><a href="../setup/index.html"><strong aria-hidden="true">1.</strong> Setup</a></li><li><a href="../ccp_concepts/index.html"><strong aria-hidden="true">2.</strong> CCP Programming Model</a></li><li><a href="../documentation/index.html"><strong aria-hidden="true">3.</strong> API Documentation</a></li><li><ol class="section"><li><a href="../documentation/datapath.html" class="active"><strong aria-hidden="true">3.1.</strong> Datapath Program Syntax</a></li><li><a href="../documentation/rust/index.html"><strong aria-hidden="true">3.2.</strong> Rust</a></li><li><a href="../documentation/python/index.html"><strong aria-hidden="true">3.3.</strong> Python</a></li></ol></li><li><a href="../tutorial/index.html"><strong aria-hidden="true">4.</strong> Tutorial</a></li><li><ol class="section"><li><a href="../tutorial/implementation.html"><strong aria-hidden="true">4.1.</strong> Structure</a></li><li><a href="../tutorial/init.html"><strong aria-hidden="true">4.2.</strong> Writing init_programs</a></li><li><a href="../tutorial/create.html"><strong aria-hidden="true">4.3.</strong> Writing create</a></li><li><a href="../tutorial/report.html"><strong aria-hidden="true">4.4.</strong> Writing on_report</a></li><li><a href="../tutorial/source.html"><strong aria-hidden="true">4.5.</strong> Full Example</a></li></ol></li><li><a href="../running.html"><strong aria-hidden="true">5.</strong> Running CCP Algorithms</a></li><li><a href="../emulation.html"><strong aria-hidden="true">6.</strong> Emulating and Debugging</a></li><li><a href="../problems/index.html"><strong aria-hidden="true">7.</strong> Common Problems</a></li><li><a href="../libccp/index.html"><strong aria-hidden="true">8.</strong> Adding Datapath Support</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">CCP Guide</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#datapath-programs" id="datapath-programs"><h1>Datapath Programs</h1></a>
<p>CCP datapath programs use a LISP-like syntax (parenthesized, prefix notation), but have a very limited set of functionality: the language is expressive enough to accomplish anything you might need for congestion control, but limited enough that the programs are very easy to reason about. The language is intentionally not turing complete for security purposes.</p>
<p>Datapath programs are <a href="https://en.wikipedia.org/wiki/Event-driven_programming">event-driven</a> programs that run in the context of each individual flow.</p>
<p>The required structure of these programs is simple: a single block of variable definitions, followed by a series of events and corresponding event handlers.</p>
<a class="header" href="#variable-definitions" id="variable-definitions"><h2>Variable Definitions</h2></a>
<p>Variables only have two possible types: booleans and integers (which are internally represented as <code>u64</code>), and must be given a default value.</p>
<p>There are two classes of variables:</p>
<ul>
<li><em>Report</em> variables are included in all reports sent to the userspace agent each time the <code>(report)</code> command is called (more on this below).</li>
<li><em>Control</em> variables are not included in reports.</li>
</ul>
<p>Adding the keyword <code>volatile</code> before a variable name means that it will automatically be reset to its provided default value when the <code>(report)</code> command is called. Both report variables and control variables may be volatile. Volatile control variables will still be reset to their default on each report, they just won't be included in the report.</p>
<p>The first expression in a datapath program <em>must</em> be the variable definition. The syntax is best explained by example:</p>
<pre><code class="language-c">(def
    (Report
        (volatile reportVarA 0)
        (reportVarB true)
        ...
    )
    (contolVarA true)
    (volatile controlVarB false)
    ...
)
</code></pre>
<p>In this example, we have two report variables and two control variables. The include &quot;report&quot; and &quot;control&quot; in the names for clarity, but this is not a requirement. When the <code>(report)</code> statement is reached, <code>reportVarA</code> and <code>controlVarB</code> will be reset to 0 and false, respectively, while <code>reportVarB</code> and <code>controlVarA</code> will not.</p>
<a class="header" href="#events-and-handlers" id="events-and-handlers"><h2>Events and Handlers</h2></a>
<p>Following the variable definition expression is a series of <code>when</code> clauses, each of which define a condition and a series of statements to be executed when that condition becomes true.</p>
<p>The syntax is <code>(when [condition] [statements])</code> where &quot;condition&quot; is any expression (all expressions evaluate to a true or false value, as in C), and &quot;statements&quot; is a series of expressions.</p>
<a class="header" href="#operations" id="operations"><h2>Operations</h2></a>
<ul>
<li><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code></li>
<li><code>:=</code> or <code>bind</code> for setting variables</li>
<li>Boolean operators (<code>||</code> and <code>&amp;&amp;</code>)</li>
<li><code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>==</code></li>
</ul>
<a class="header" href="#control-flow" id="control-flow"><h2>Control Flow</h2></a>
<ul>
<li><code>If</code> statements</li>
<li>No loops</li>
<li><code>(fallthrough)</code></li>
<li><code>(report)</code></li>
</ul>
<a class="header" href="#flow-and-ack-statistics" id="flow-and-ack-statistics"><h2>Flow and ACK Statistics</h2></a>
<p>The <code>Flow</code> struct provides read-only access to a number of a flow-level statistics that are maintained by the datapath:</p>
<ul>
<li><code>Flow.packets_in_flight</code></li>
<li><code>Flow.bytes_in_flight</code></li>
<li><code>Flow.bytes_pending</code>: bytes currently buffered in the network stack waiting to be sent</li>
<li><code>Flow.rtt_sample_us</code>: sample of the RTT in microseconds based on ACK arrivals for this flow</li>
<li><code>Flow.was_timeout</code>: boolean indicating whether or not this flow has received a timeout</li>
<li><code>Flow.rate_incoming</code>: estimate of the receive rate over the last RTT</li>
<li><code>Flow.rate_outgoing</code>: estimate of the send rate over the last RTT</li>
</ul>
<p>The <code>Ack</code> struct provides read-only access to specific information from the single most recently received ack.</p>
<ul>
<li><code>Ack.bytes_acked</code></li>
<li><code>Ack.packets_acked</code></li>
<li><code>Ack.bytes_misordered</code></li>
<li><code>Ack.packets_misordered</code></li>
<li><code>Ack.ecn_bytes</code></li>
<li><code>Ack.ecn_packets</code></li>
<li><code>Ack.lost_pkts_sample</code></li>
<li><code>Ack.now</code></li>
</ul>
<a class="header" href="#sending-behavior" id="sending-behavior"><h2>Sending Behavior</h2></a>
<p>The sending behavior of a flow can only be controlled by modifying either the <code>Cwnd</code> or <code>Rate</code> variables. These can be set either directly inside of a datapath program, or via an <code>update_fields</code> call in the userspace agent.</p>
<p>For example, to increase the cwnd by the number of bytes acked on each ack (i.e. slow-start):</p>
<pre><code class="language-c">(when true
    (:= Cwnd (+ Cwnd Ack.bytes_acked))
)
</code></pre>
<p>This is equivalent to <code>cwnd += Ack.bytes_acked</code>.</p>
<a class="header" href="#common-expressions" id="common-expressions"><h2>Common Expressions</h2></a>
<a class="header" href="#when-true" id="when-true"><h3>when true</h3></a>
<p>Expressions inside of a <code>when true</code> clause are run on every ack.</p>
<a class="header" href="#timers" id="timers"><h3>Timers</h3></a>
<p>Timers can be achieved using <code>Micros</code></p>
<a class="header" href="#rate-patterns" id="rate-patterns"><h3>Rate Patterns</h3></a>
<pre><code>(
)
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../documentation/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../documentation/rust/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../documentation/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../documentation/rust/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
